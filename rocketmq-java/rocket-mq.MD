# 消息中间件实战高手



## 1. 订单系统的技术挑战

### 1.1 业务流程

![](./images/mq-01.png)



+ 当用户对购物车中选中的一批商品确认下单的时候，会先出来一个确认订单的界面
+ 用户得先确认这个订单中的商品、价格、运费无误，而且在这个过程中可以选择是否要使用优惠券、促销活动的。
+ 用户还应该在这个界面中确认自己的快递方式，收件地址，是否要开发票以及发票的抬头是什么。
+ 当用户完成这些信息确认之后，就可以确定下单。



### 1.2 系统流程

![](./images/mq-02.png)

订单系统最核心的一个环节就出现了，就是要根据APP端传递过来的种种信息，完成订单的创建，此时需要在数据库中创建对应的订单记录，

+ 正式确认下单之后，除了在数据库中创建这个订单之外
+ 会跳转到支付界面，让你通过选择好的支付方式完成这个订单的支付。比如跳转到支付宝或者微信，让你在支付宝或者微信中完成支付，
+ 在完成了支付之后，一般来说，支付宝或者微信之类的支付系统，会反过来回调我们的一个接口，通知我们本次支付已经成功。
+ 当我们收到支付成功的通知之后，就需要安排给用户进行配送发货。
+ 因为一般电商APP都经常会做一些鼓励用户购买的活动，比如你购买之后送一些优惠券，下次购买可以抵用5块钱，或者给你发一个几块钱的现金红包。此外，还会给你发送一个push推送，通知你支付成功准备发货，这个推送很多时候是通过短信通知的。



### 1.3 核心模块

![](./images/mq-03.png)

+ 首先订单系统在完成核心的下单业务流程之后，用户一定会**查询订单**，那么订单系统务必要提供对应的订单查询功能。
+ **下单模块**主要是用于创建订单
+ **异步模块**主要是在支付成功之后发优惠券、红包和推送，查询模块主要是提供订单的查询。
+ 订单系统中也得提供**退货功能**，在下面的图中我们加入退货模块。
+ 订单系统跟**第三方系统的对接。**
+ 订单数据是一个公司的核心数据，很多时候公司内部的其他团队，比如**大数据团队可能就需要获取订单数据进行分析**
+ 在类似双11、秒杀等大促场景下，等待一些特价促销的商品开卖之后进行抢购，此时可能会对订单系统会产生一个流量洪峰，甚至影响正常的一些下单功能。往往要提供一个专门用于抗双11、秒杀等活动的**大促模块，专门用于处理特殊活动下的高并发下单场景**



### 1.4 系统压力

活跃的用户数量是一两百万的样子，然**后每天新增的订单数量，目前大概是几十万的样子**。

在一些双11、618等大促活动的时候，我们现在的订单系统就可以达到单日**百万订单的量级了**，所以我们的系统压力还是比较大的。

QPS，也就是系统每秒的查询数量，这个指标是说订单系统所有的核心以及非核心功能模块加起来，每秒钟有多少请求量。

+ 在往常每天的高峰期，大概最多会达到**每秒2000左右的访问量**，不算太大。

+ 但是如果要是有那种特价商品限时秒杀的活动，那**可能就会达到每秒1万以上的访问压力**了。

  

压力主要在两方面：

- 一方面是订单系统日益增长的数据量
- 一方面是在大促活动时每秒上万的访问压力



### 1.5 性能瓶颈

![](./images/mq-04.png)



系统每天高峰期**大概会有2000左右的QPS,也就是每秒会有2000左右的请求过来,这就是当前系统的个最大压力**。在非高峰的时候,其实远远达不到这么高的并发,所以先考志高峰期的压力就可以了。

一个系统的工程师来说,应该了解的事情就是你的APP用户的生活习惯和APP的使用习惯，这些用户的使用惯直接决定了他们使用我们APP的频率，时间段和时长。


通过线上ー些数据的统计，**我们大致知道,咱们这个APP,基本上80%的用户都习惯于在晩上六点过后到凌晨十ー点这几个小时使用**，所以在这儿个小时内,可以认为有80万左石的用户会使用APP。因此对我们订单系统而言，主要的访问量就是下订单以及对订单的索，査询，少量的退款等渠作。


因为我们的电商AP有两个特点，第一，真实的系统访问负载应该是一个半园形的曲线,类似下面这样。

![](./images/mq-05.png)



比如从晚上6点开始访问量开始加，一直到可能晚上把几点到一个顶点,访问是最大的然后慢慢的开始下落,到上十一点就变得较低。

现在线上的**订单系统一共部署了8台机器,每台机器的配置是4核8G**。因此高峰期每台机器的请求大概是每秒200~300之间。

![](./images/mq-06.png)



但是这8台订单系统部署的服务器都是连接一台数据库服务器的,**数据库服务器的配置是16核32G**,而且是SSD同态硬莅的,用的是比
较高配置比较贵的机器,因此性能会更好一些。

现在线上这样的一个机器部著情況,**在高峰期毎秒2000以上请求的情況下是很轻松可以抗住的**。因为4核8G的机器一般每秒钟抗几百请求都没

然后数据库服务器因为用的是**16核32G的配置,因此之前压测的时候知道他即使每秒上万请求也能做到,只不过那个已经是他的极限**了,会导致数据库服务器的CPU，磁盘，网络，IO，内存的使用率几乎达到极限。现在数据库服务器在高峰期的每秒请求量也就是三四千的样子因此基本上还没什么大问题。

![](./images/mq-07.png)

这八个步骤全部执行完，加起来大概需要1秒~2秒的时间。**高峰期数据库的负载较高，会导致数据库磁盘，IO, CPU负载很高，导致数据库执行SQL语句下降**，导致用户等待时间过长。

